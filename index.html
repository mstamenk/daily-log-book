<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Focus 3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['system-ui','-apple-system','BlinkMacSystemFont','"Segoe UI"','sans-serif'],
            mono: ['ui-monospace','SFMono-Regular','Menlo','Monaco','Consolas','"Liberation Mono"','"Courier New"','monospace'],
          },
        },
      },
    };
  </script>
</head>
<body class="min-h-screen bg-gradient-to-b from-sky-50 via-slate-50 to-slate-100 text-slate-900 px-4 py-6">
  <div class="w-full max-w-5xl mx-auto border border-sky-100 rounded-3xl bg-white/90 shadow-lg shadow-sky-100/70 px-6 py-6 sm:px-10 sm:py-8">
    <div class="h-1 w-24 rounded-full bg-gradient-to-r from-sky-400 to-sky-600 mb-4"></div>

    <!-- Header -->
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div>
        <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">
          Daily Focus 3
        </h1>
        <p class="text-sm text-slate-500 mt-1">
          One must-do, one quick win, one optional. Plus small tasks, deadlines and a brain dump.
        </p>
      </div>
      <div class="text-right text-xs text-slate-400">
        <p id="date-human-label" class="font-medium text-slate-600"></p>
        <p>All data stays on this device.</p>
      </div>
    </header>

    <!-- Date navigation -->
    <section class="mt-6 border-t border-slate-200 pt-4">
      <div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4">
        <div class="flex items-center gap-2 text-xs text-slate-600">
          <span class="font-medium text-slate-700">Day:</span>
          <span
            id="date-short-label"
            class="px-3 py-1 rounded-full bg-sky-50/80 border border-sky-200 text-sky-800 shadow-sm"
          ></span>
        </div>
        <div class="flex items-center gap-2 text-xs">
          <button
            id="date-prev-btn"
            type="button"
            class="inline-flex items-center justify-center rounded-full border border-slate-300 bg-white px-3 py-1 hover:bg-sky-50 text-slate-700"
          >
            ◀
          </button>
          <button
            id="date-today-btn"
            type="button"
            class="inline-flex items-center justify-center rounded-full border border-sky-300 bg-sky-50/80 px-3.5 py-1 hover:bg-sky-100 text-sky-800 shadow-sm"
          >
            Today
          </button>
          <button
            id="date-next-btn"
            type="button"
            class="inline-flex items-center justify-center rounded-full border border-slate-300 bg-white px-3 py-1 hover:bg-sky-50 text-slate-700"
          >
            ▶
          </button>
        </div>

        <div class="sm:ml-auto flex flex-col sm:flex-row sm:items-center gap-3">
          <div>
            <label class="block text-xs text-slate-500 mb-1" for="date-input">Jump to date</label>
            <input
              id="date-input"
              type="date"
              class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
            />
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1" for="font-size-select">Font size</label>
            <select
              id="font-size-select"
              class="rounded-lg border border-slate-300 bg-white px-2 py-2 text-sm text-slate-900 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
            >
              <option value="small">Small</option>
              <option value="medium">Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
          <div class="pt-1 sm:pt-6">
            <span class="block text-xs text-slate-500 mb-1">Backup</span>
            <div class="flex items-center gap-2 text-xs">
              <button
                id="export-btn"
                type="button"
                class="inline-flex items-center justify-center rounded-full border border-sky-300 bg-sky-50/70 px-3 py-1 text-xs font-medium text-sky-800 hover:bg-sky-100"
              >
                Export
              </button>
              <button
                id="import-btn"
                type="button"
                class="inline-flex items-center justify-center rounded-full border border-sky-300 bg-sky-50/70 px-3 py-1 text-xs font-medium text-sky-800 hover:bg-sky-100"
              >
                Import
              </button>
              <input
                id="import-file"
                type="file"
                accept="application/json"
                class="hidden"
              />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Summary strip -->
    <section class="mt-4">
      <div class="rounded-2xl border border-sky-100 bg-gradient-to-r from-sky-50/90 via-slate-50/90 to-sky-50/90 px-4 py-3 text-xs flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <span class="font-medium text-sky-900">Summary</span>
        <span id="summary-text" class="text-slate-700">
          Focus: 0/3 tasks checked · Small tasks: 0/0 done · Deadlines: 0/0 done · Brain dump: empty · Lab log: empty
        </span>
      </div>
    </section>

    <!-- Focus 3 section -->
    <section class="mt-6">
      <div class="flex items-center justify-between gap-2 mb-3">
        <h2 class="text-xs font-semibold tracking-wide text-slate-700 uppercase">
          Focus for today
        </h2>
        <p class="text-xs text-slate-500">
          Keep it realistic. One clear win is enough.
        </p>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <!-- Must-do -->
        <div id="main-must-row" class="rounded-2xl border border-sky-100 bg-sky-50/60 px-4 py-4 flex flex-col gap-2 transition-opacity">
          <div class="flex items-center gap-2">
            <input
              id="main-must-done"
              type="checkbox"
              class="rounded border-slate-400 bg-white text-sky-600 focus:ring-sky-500"
            />
            <div class="flex flex-col">
              <span class="text-xs font-semibold uppercase tracking-wide text-slate-700">
                To be done
              </span>
              <span class="text-xs text-slate-500">
                If nothing else, do this.
              </span>
            </div>
          </div>
          <input
            id="main-must-text"
            type="text"
            placeholder="e.g. finish ERC introduction section"
            class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
          />
        </div>

        <!-- Quick win -->
        <div id="main-quick-row" class="rounded-2xl border border-sky-100 bg-sky-50/60 px-4 py-4 flex flex-col gap-2 transition-opacity">
          <div class="flex items-center gap-2">
            <input
              id="main-quick-done"
              type="checkbox"
              class="rounded border-slate-400 bg-white text-sky-600 focus:ring-sky-500"
            />
            <div class="flex flex-col">
              <span class="text-xs font-semibold uppercase tracking-wide text-slate-700">
                Quick win
              </span>
              <span class="text-xs text-slate-500">
                Small task that makes you feel on top.
              </span>
            </div>
          </div>
          <input
            id="main-quick-text"
            type="text"
            placeholder="e.g. reply to X about HHH plots"
            class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
          />
        </div>

        <!-- Optional -->
        <div id="main-optional-row" class="rounded-2xl border border-sky-100 bg-sky-50/60 px-4 py-4 flex flex-col gap-2 transition-opacity">
          <div class="flex items-center gap-2">
            <input
              id="main-optional-done"
              type="checkbox"
              class="rounded border-slate-400 bg-white text-sky-600 focus:ring-sky-500"
            />
            <div class="flex flex-col">
              <span class="text-xs font-semibold uppercase tracking-wide text-slate-700">
                Optional
              </span>
              <span class="text-xs text-slate-500">
                Nice to have, not mandatory.
              </span>
            </div>
          </div>
          <input
            id="main-optional-text"
            type="text"
            placeholder="e.g. tidy up SuperChic notes"
            class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
          />
        </div>
      </div>
    </section>

    <!-- Small tasks + Important deadlines -->
    <section class="mt-8 grid md:grid-cols-2 gap-8">
      <!-- Small tasks -->
      <div>
        <div class="flex items-center justify-between gap-2 mb-2">
          <h2 class="text-xs font-semibold tracking-wide text-slate-700 uppercase">
            Small tasks
          </h2>
          <button
            id="small-add-btn"
            type="button"
            class="inline-flex items-center gap-1 rounded-full border border-sky-300 bg-sky-50/70 px-3 py-1 text-xs font-medium text-sky-800 hover:bg-sky-100"
          >
            + Add
          </button>
        </div>
        <p class="text-xs text-slate-500 mb-2">
          Quick items under ~10 minutes. Good to sprinkle between focus blocks.
        </p>
        <div
          id="small-tasks-list"
          class="rounded-2xl border border-sky-100 bg-sky-50/40 px-3 py-2 max-h-80 overflow-y-auto"
        >
          <!-- tasks go here -->
        </div>
      </div>

      <!-- Important deadlines -->
      <div>
        <div class="flex items-center justify-between gap-2 mb-2">
          <h2 class="text-xs font-semibold tracking-wide text-slate-700 uppercase">
            Important deadlines
          </h2>
          <button
            id="deadline-add-btn"
            type="button"
            class="inline-flex items-center gap-1 rounded-full border border-sky-300 bg-sky-50/70 px-3 py-1 text-xs font-medium text-sky-800 hover:bg-sky-100"
          >
            + Add
          </button>
        </div>
        <p class="text-xs text-slate-500 mb-2">
          Grants, talks, reviews… Tick them once they’re past or done.
        </p>
        <div
          id="deadlines-list"
          class="rounded-2xl border border-sky-100 bg-sky-50/40 px-3 py-2 max-h-80 overflow-y-auto"
        >
          <!-- deadlines go here -->
        </div>
      </div>
    </section>

    <!-- Brain dump: full width -->
    <section class="mt-8">
      <h2 class="text-xs font-semibold tracking-wide text-slate-700 uppercase mb-2">
        Brain dump / Name a stress
      </h2>
      <p class="text-xs text-slate-500 mb-2">
        Offload worries, to-dos, or random thoughts. They don’t have to be tidy.
      </p>
      <textarea
        id="brain-dump"
        rows="8"
        placeholder="e.g. I'm worried about the ERC deadline and HHH analysis overlap. Possible next step: block 2x 25-minute sessions just for ERC today."
        class="w-full rounded-2xl border border-sky-100 bg-sky-50/60 px-3 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
      ></textarea>
    </section>

    <!-- Lab log -->
    <section class="mt-6">
      <h2 class="text-xs font-semibold tracking-wide text-slate-700 uppercase mb-2">
        Lab log / Notes
      </h2>
      <p class="text-xs text-slate-500 mb-2">
        Short notes on analysis progress, detector work, ideas, or questions to revisit.
      </p>
      <textarea
        id="lab-log"
        rows="6"
        placeholder="e.g. Checked new HHH6b fit with updated k₃–k₄ grid; need to rerun toys with tighter proton selection."
        class="w-full rounded-2xl border border-sky-100 bg-sky-50/60 px-3 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
      ></textarea>
    </section>

    <!-- Reflection: Today / Tomorrow -->
    <section class="mt-8">
      <h2 class="text-xs font-semibold tracking-wide text-slate-700 uppercase mb-3">
        Wrap-up
      </h2>
      <div class="grid md:grid-cols-2 gap-8">
        <div>
          <label for="finished-today" class="block text-xs font-medium text-slate-700 mb-1">
            Today I finished:
          </label>
          <textarea
            id="finished-today"
            rows="6"
            placeholder="e.g. Completed the ERC introduction, fixed the SuperChic bug, and went for a 30-minute walk."
            class="w-full rounded-2xl border border-sky-100 bg-sky-50/40 px-3 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
          ></textarea>
        </div>
        <div>
          <label for="start-tomorrow" class="block text-xs font-medium text-slate-700 mb-1">
            Tomorrow, I'll start with:
          </label>
          <textarea
            id="start-tomorrow"
            rows="6"
            placeholder="e.g. First 25-minute block on HHH systematics, then 25 minutes on ERC methodology section."
            class="w-full rounded-2xl border border-sky-100 bg-sky-50/40 px-3 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500"
          ></textarea>
        </div>
      </div>
    </section>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = 'daily_focus_3_planner_v1';

      const state = {
        selectedDate: null, // 'YYYY-MM-DD'
        days: {},           // date string -> dayData
        settings: { fontSize: 'medium' },
      };

      // DOM references
      const dateHumanLabel = document.getElementById('date-human-label');
      const dateShortLabel = document.getElementById('date-short-label');
      const dateInput = document.getElementById('date-input');
      const prevBtn = document.getElementById('date-prev-btn');
      const nextBtn = document.getElementById('date-next-btn');
      const todayBtn = document.getElementById('date-today-btn');
      const summaryTextSpan = document.getElementById('summary-text');
      const fontSizeSelect = document.getElementById('font-size-select');

      const mainMustRow = document.getElementById('main-must-row');
      const mainQuickRow = document.getElementById('main-quick-row');
      const mainOptionalRow = document.getElementById('main-optional-row');

      const mainMustDone = document.getElementById('main-must-done');
      const mainMustText = document.getElementById('main-must-text');
      const mainQuickDone = document.getElementById('main-quick-done');
      const mainQuickText = document.getElementById('main-quick-text');
      const mainOptionalDone = document.getElementById('main-optional-done');
      const mainOptionalText = document.getElementById('main-optional-text');

      const smallTasksList = document.getElementById('small-tasks-list');
      const smallAddBtn = document.getElementById('small-add-btn');

      const deadlinesList = document.getElementById('deadlines-list');
      const deadlineAddBtn = document.getElementById('deadline-add-btn');

      const brainDumpTextarea = document.getElementById('brain-dump');
      const labLogTextarea = document.getElementById('lab-log');
      const finishedTodayTextarea = document.getElementById('finished-today');
      const startTomorrowTextarea = document.getElementById('start-tomorrow');

      const exportBtn = document.getElementById('export-btn');
      const importBtn = document.getElementById('import-btn');
      const importFileInput = document.getElementById('import-file');

      function makeId() {
        return (
          Date.now().toString(36) +
          Math.random().toString(36).slice(2, 7)
        );
      }

      function formatDateLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return year + '-' + month + '-' + day;
      }

      function getTodayString() {
        return formatDateLocal(new Date());
      }

      function dateStringToDate(str) {
        const [y, m, d] = str.split('-').map(Number);
        return new Date(y, m - 1, d);
      }

      function shiftDateString(str, deltaDays) {
        const d = dateStringToDate(str);
        d.setDate(d.getDate() + deltaDays);
        return formatDateLocal(d);
      }

      function formatHumanDate(dateStr) {
        const d = dateStringToDate(dateStr);
        const optsLong = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
        const optsShort = { weekday: 'short', month: 'short', day: 'numeric' };
        return {
          long: d.toLocaleDateString(undefined, optsLong),
          short: d.toLocaleDateString(undefined, optsShort),
        };
      }

      function createEmptyDay() {
        return {
          main: {
            must: { text: '', done: false },
            quick: { text: '', done: false },
            optional: { text: '', done: false },
          },
          smallTasks: [],
          importantDeadlines: [],
          brainDump: '',
          labLog: '',
          finishedToday: '',
          startTomorrow: '',
        };
      }

      function loadStore() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) {
            state.days = {};
            state.settings = { fontSize: 'medium' };
            return;
          }
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object') {
            state.days = parsed.days || {};
            state.settings = parsed.settings || { fontSize: 'medium' };
          } else {
            state.days = {};
            state.settings = { fontSize: 'medium' };
          }
        } catch (e) {
          console.warn('Failed to load planner data', e);
          state.days = {};
          state.settings = { fontSize: 'medium' };
        }
      }

      function saveStore() {
        try {
          localStorage.setItem(
            STORAGE_KEY,
            JSON.stringify({
              days: state.days,
              settings: state.settings,
            })
          );
        } catch (e) {
          console.warn('Failed to save planner data', e);
        }
      }

      function ensureDay(dateStr) {
        if (!state.days[dateStr]) {
          state.days[dateStr] = createEmptyDay();
        } else {
          const day = state.days[dateStr];
          if (!day.main) day.main = createEmptyDay().main;
          if (!day.smallTasks) day.smallTasks = [];
          if (!day.importantDeadlines) day.importantDeadlines = [];
          if (typeof day.brainDump !== 'string') day.brainDump = '';
          if (typeof day.labLog !== 'string') day.labLog = '';
          if (typeof day.finishedToday !== 'string') day.finishedToday = '';
          if (typeof day.startTomorrow !== 'string') day.startTomorrow = '';
          ['must', 'quick', 'optional'].forEach((k) => {
            if (!day.main[k]) day.main[k] = { text: '', done: false };
            if (typeof day.main[k].text !== 'string') day.main[k].text = '';
            if (typeof day.main[k].done !== 'boolean') day.main[k].done = false;
          });
        }
      }

      function getDay(dateStr) {
        ensureDay(dateStr);
        return state.days[dateStr];
      }

      function carryForwardTasks(fromDate, toDate) {
        const fromDay = getDay(fromDate);
        const toDay = getDay(toDate);

        ['smallTasks', 'importantDeadlines'].forEach((listName) => {
          if (!Array.isArray(fromDay[listName])) return;
          if (!Array.isArray(toDay[listName])) toDay[listName] = [];

          fromDay[listName].forEach((task) => {
            if (task.done) return;
            const text = (task.text || '').trim();
            if (!text) return;

            const exists = toDay[listName].some(
              (t) => (t.text || '').trim() === text
            );
            if (!exists) {
              toDay[listName].push({
                id: makeId(),
                text: text,
                done: false,
              });
            }
          });
        });
      }

      function maybeCarryForward(oldDate, newDate) {
        if (!oldDate) return;
        if (newDate <= oldDate) return; // only roll forward to later days
        carryForwardTasks(oldDate, newDate);
      }

      function setSelectedDate(dateStr) {
        const old = state.selectedDate;
        if (old && dateStr !== old) {
          maybeCarryForward(old, dateStr);
        }
        state.selectedDate = dateStr;
        ensureDay(dateStr);
        render();
        saveStore();
      }

      function styleMainRow(rowEl, task) {
        const baseClasses =
          'rounded-2xl border border-sky-100 bg-sky-50/60 px-4 py-4 flex flex-col gap-2 transition-opacity';
        rowEl.className = baseClasses + (task.done ? ' opacity-60' : '');
      }

      function renderMain(day) {
        const main = day.main;

        mainMustDone.checked = !!main.must.done;
        mainMustText.value = main.must.text || '';
        mainQuickDone.checked = !!main.quick.done;
        mainQuickText.value = main.quick.text || '';
        mainOptionalDone.checked = !!main.optional.done;
        mainOptionalText.value = main.optional.text || '';

        styleMainRow(mainMustRow, main.must);
        styleMainRow(mainQuickRow, main.quick);
        styleMainRow(mainOptionalRow, main.optional);
      }

      function styleSmallTaskRow(rowEl, task) {
        const textEl = rowEl.querySelector('input[type="text"]');
        if (!textEl) return;
        if (task.done) {
          textEl.classList.add('line-through', 'text-slate-400');
        } else {
          textEl.classList.remove('line-through', 'text-slate-400');
        }
      }

      function styleDeadlineRow(rowEl, task) {
        const textEl = rowEl.querySelector('input[type="text"]');
        if (!textEl) return;
        if (task.done) {
          textEl.classList.add('line-through', 'text-slate-400');
        } else {
          textEl.classList.remove('line-through', 'text-slate-400');
        }
      }

      function renderSmallTasks(day) {
        smallTasksList.innerHTML = '';
        if (!Array.isArray(day.smallTasks)) {
          day.smallTasks = [];
        }

        if (day.smallTasks.length === 0) {
          const placeholder = document.createElement('p');
          placeholder.className = 'text-xs text-slate-400 py-2';
          placeholder.textContent = 'No small tasks yet. Add one above.';
          smallTasksList.appendChild(placeholder);
          return;
        }

        day.smallTasks.forEach((task) => {
          const row = document.createElement('div');
          row.className =
            'flex items-center gap-2 py-1.5 border-b border-slate-200 last:border-b-0';
          row.dataset.id = task.id;

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className =
            'mt-0.5 rounded border-slate-400 bg-white text-sky-600 focus:ring-sky-500';
          checkbox.checked = !!task.done;

          const input = document.createElement('input');
          input.type = 'text';
          input.value = task.text || '';
          input.placeholder = 'Small task...';
          input.className =
            'flex-1 rounded-lg border border-transparent bg-transparent px-1 py-1.5 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:border-sky-400 focus:bg-white';

          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.textContent = '✕';
          deleteBtn.title = 'Remove task';
          deleteBtn.className =
            'ml-1 inline-flex items-center justify-center text-[11px] text-slate-400 hover:text-red-500 px-1';

          checkbox.addEventListener('change', function () {
            const day = getDay(state.selectedDate);
            task.done = !!checkbox.checked;
            saveStore();
            styleSmallTaskRow(row, task);
            renderSummary(day);
          });

          input.addEventListener('input', function () {
            const day = getDay(state.selectedDate);
            task.text = input.value;
            saveStore();
            renderSummary(day);
          });

          deleteBtn.addEventListener('click', function () {
            const day = getDay(state.selectedDate);
            day.smallTasks = day.smallTasks.filter((t) => t.id !== task.id);
            saveStore();
            renderSmallTasks(day);
            renderSummary(day);
          });

          row.appendChild(checkbox);
          row.appendChild(input);
          row.appendChild(deleteBtn);
          smallTasksList.appendChild(row);

          styleSmallTaskRow(row, task);
        });
      }

      function renderDeadlines(day) {
        deadlinesList.innerHTML = '';
        if (!Array.isArray(day.importantDeadlines)) {
          day.importantDeadlines = [];
        }

        if (day.importantDeadlines.length === 0) {
          const placeholder = document.createElement('p');
          placeholder.className = 'text-xs text-slate-400 py-2';
          placeholder.textContent = 'No deadlines yet. Add one above.';
          deadlinesList.appendChild(placeholder);
          return;
        }

        day.importantDeadlines.forEach((task) => {
          const row = document.createElement('div');
          row.className =
            'flex items-center gap-2 py-1.5 border-b border-slate-200 last:border-b-0';
          row.dataset.id = task.id;

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className =
            'mt-0.5 rounded border-slate-400 bg-white text-sky-600 focus:ring-sky-500';
          checkbox.checked = !!task.done;

          const input = document.createElement('input');
          input.type = 'text';
          input.value = task.text || '';
          input.placeholder = 'Deadline (e.g. ERC draft to co-authors, 2026-01-15)...';
          input.className =
            'flex-1 rounded-lg border border-transparent bg-transparent px-1 py-1.5 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:border-sky-400 focus:bg-white';

          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.textContent = '✕';
          deleteBtn.title = 'Remove deadline';
          deleteBtn.className =
            'ml-1 inline-flex items-center justify-center text-[11px] text-slate-400 hover:text-red-500 px-1';

          checkbox.addEventListener('change', function () {
            const day = getDay(state.selectedDate);
            task.done = !!checkbox.checked;
            saveStore();
            styleDeadlineRow(row, task);
            renderSummary(day);
          });

          input.addEventListener('input', function () {
            const day = getDay(state.selectedDate);
            task.text = input.value;
            saveStore();
            renderSummary(day);
          });

          deleteBtn.addEventListener('click', function () {
            const day = getDay(state.selectedDate);
            day.importantDeadlines = day.importantDeadlines.filter(
              (t) => t.id !== task.id
            );
            saveStore();
            renderDeadlines(day);
            renderSummary(day);
          });

          row.appendChild(checkbox);
          row.appendChild(input);
          row.appendChild(deleteBtn);
          deadlinesList.appendChild(row);

          styleDeadlineRow(row, task);
        });
      }

      function renderBrainDump(day) {
        brainDumpTextarea.value = day.brainDump || '';
      }

      function renderLabLog(day) {
        if (!labLogTextarea) return;
        labLogTextarea.value = day.labLog || '';
      }

      function renderReflection(day) {
        finishedTodayTextarea.value = day.finishedToday || '';
        startTomorrowTextarea.value = day.startTomorrow || '';
      }

      function renderDateLabels() {
        const dateStr = state.selectedDate;
        const { long, short } = formatHumanDate(dateStr);
        dateHumanLabel.textContent = long;
        dateShortLabel.textContent = short;
        dateInput.value = dateStr;
      }

      function renderSummary(day) {
        if (!summaryTextSpan) return;

        const main = day.main;
        const focusTotal = 3;
        let focusDone = 0;
        ['must', 'quick', 'optional'].forEach((k) => {
          if (main[k].done) focusDone += 1;
        });

        const totalSmall = Array.isArray(day.smallTasks)
          ? day.smallTasks.length
          : 0;
        const doneSmall = totalSmall
          ? day.smallTasks.filter((t) => t.done).length
          : 0;

        const totalDead = Array.isArray(day.importantDeadlines)
          ? day.importantDeadlines.length
          : 0;
        const doneDead = totalDead
          ? day.importantDeadlines.filter((t) => t.done).length
          : 0;

        const brainStatus = (day.brainDump || '').trim().length
          ? 'written'
          : 'empty';

        const labStatus = (day.labLog || '').trim().length
          ? 'written'
          : 'empty';

        summaryTextSpan.textContent =
          'Focus: ' +
          focusDone +
          '/' +
          focusTotal +
          ' tasks checked · Small tasks: ' +
          doneSmall +
          '/' +
          totalSmall +
          ' done · Deadlines: ' +
          doneDead +
          '/' +
          totalDead +
          ' done · Brain dump: ' +
          brainStatus +
          ' · Lab log: ' +
          labStatus;
      }

      function render() {
        const day = getDay(state.selectedDate);
        renderDateLabels();
        renderMain(day);
        renderSmallTasks(day);
        renderDeadlines(day);
        renderBrainDump(day);
        renderLabLog(day);
        renderReflection(day);
        renderSummary(day);
      }

      function addSmallTask() {
        const day = getDay(state.selectedDate);
        if (!Array.isArray(day.smallTasks)) day.smallTasks = [];

        const newTask = {
          id: makeId(),
          text: '',
          done: false,
        };
        day.smallTasks.push(newTask);
        saveStore();
        renderSmallTasks(day);
        renderSummary(day);

        setTimeout(() => {
          const row = smallTasksList.querySelector(
            'div[data-id="' + newTask.id + '"]'
          );
          if (!row) return;
          const input = row.querySelector('input[type="text"]');
          if (input) input.focus();
        }, 0);
      }

      function addDeadline() {
        const day = getDay(state.selectedDate);
        if (!Array.isArray(day.importantDeadlines)) day.importantDeadlines = [];

        const newTask = {
          id: makeId(),
          text: '',
          done: false,
        };
        day.importantDeadlines.push(newTask);
        saveStore();
        renderDeadlines(day);
        renderSummary(day);

        setTimeout(() => {
          const row = deadlinesList.querySelector(
            'div[data-id="' + newTask.id + '"]'
          );
          if (!row) return;
          const input = row.querySelector('input[type="text"]');
          if (input) input.focus();
        }, 0);
      }

      function initMainHandlers() {
        const config = [
          {
            key: 'must',
            textEl: mainMustText,
            doneEl: mainMustDone,
            rowEl: mainMustRow,
          },
          {
            key: 'quick',
            textEl: mainQuickText,
            doneEl: mainQuickDone,
            rowEl: mainQuickRow,
          },
          {
            key: 'optional',
            textEl: mainOptionalText,
            doneEl: mainOptionalDone,
            rowEl: mainOptionalRow,
          },
        ];

        config.forEach(({ key, textEl, doneEl, rowEl }) => {
          textEl.addEventListener('input', function () {
            const day = getDay(state.selectedDate);
            day.main[key].text = textEl.value;
            saveStore();
            renderSummary(day);
          });

          doneEl.addEventListener('change', function () {
            const day = getDay(state.selectedDate);
            day.main[key].done = !!doneEl.checked;
            saveStore();
            styleMainRow(rowEl, day.main[key]);
            renderSummary(day);
          });
        });
      }

      function applyFontSize() {
        const setting = (state.settings && state.settings.fontSize) || 'medium';
        let px;
        if (setting === 'small') px = 15;
        else if (setting === 'large') px = 18;
        else px = 16; // medium default
        document.documentElement.style.fontSize = px + 'px';
      }

      function initFontSizeUI() {
        if (!fontSizeSelect) return;
        fontSizeSelect.value = state.settings.fontSize || 'medium';
        applyFontSize();

        fontSizeSelect.addEventListener('change', function () {
          state.settings.fontSize = fontSizeSelect.value || 'medium';
          applyFontSize();
          saveStore();
        });
      }

      function initOtherHandlers() {
        smallAddBtn.addEventListener('click', function () {
          addSmallTask();
        });

        deadlineAddBtn.addEventListener('click', function () {
          addDeadline();
        });

        brainDumpTextarea.addEventListener('input', function () {
          const day = getDay(state.selectedDate);
          day.brainDump = brainDumpTextarea.value;
          saveStore();
          renderSummary(day);
        });

        if (labLogTextarea) {
          labLogTextarea.addEventListener('input', function () {
            const day = getDay(state.selectedDate);
            day.labLog = labLogTextarea.value;
            saveStore();
            renderSummary(day);
          });
        }

        finishedTodayTextarea.addEventListener('input', function () {
          const day = getDay(state.selectedDate);
          day.finishedToday = finishedTodayTextarea.value;
          saveStore();
        });

        startTomorrowTextarea.addEventListener('input', function () {
          const day = getDay(state.selectedDate);
          day.startTomorrow = startTomorrowTextarea.value;
          saveStore();
        });

        prevBtn.addEventListener('click', function () {
          const newDate = shiftDateString(state.selectedDate, -1);
          setSelectedDate(newDate);
        });

        nextBtn.addEventListener('click', function () {
          const newDate = shiftDateString(state.selectedDate, 1);
          setSelectedDate(newDate);
        });

        todayBtn.addEventListener('click', function () {
          const today = getTodayString();
          setSelectedDate(today);
        });

        dateInput.addEventListener('change', function () {
          if (!dateInput.value) return;
          setSelectedDate(dateInput.value);
        });

        if (exportBtn) {
          exportBtn.addEventListener('click', function () {
            try {
              const payload = {
                version: 1,
                exportedAt: new Date().toISOString(),
                data: {
                  days: state.days,
                  settings: state.settings,
                },
              };
              const blob = new Blob([JSON.stringify(payload, null, 2)], {
                type: 'application/json',
              });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'daily-focus-3-backup-' + getTodayString() + '.json';
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(url);
            } catch (e) {
              console.warn('Export failed', e);
              alert('Sorry, export failed.');
            }
          });
        }

        if (importBtn && importFileInput) {
          importBtn.addEventListener('click', function () {
            importFileInput.click();
          });

          importFileInput.addEventListener('change', function () {
            const file = importFileInput.files && importFileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (event) {
              try {
                const text = event.target.result;
                const parsed = JSON.parse(text);
                const payload = parsed && parsed.data ? parsed.data : parsed;
                if (!payload || typeof payload !== 'object') {
                  throw new Error('Invalid file');
                }
                if (!payload.days || typeof payload.days !== 'object') {
                  throw new Error('Missing days');
                }
                state.days = payload.days;
                state.settings = payload.settings || { fontSize: 'medium' };
                applyFontSize();
                saveStore();
                if (!state.selectedDate) {
                  state.selectedDate = getTodayString();
                }
                ensureDay(state.selectedDate);
                render();
                alert('Import successful.');
              } catch (e) {
                console.error('Import failed', e);
                alert('Could not import this file. Is it a valid Daily Focus 3 export?');
              } finally {
                importFileInput.value = '';
              }
            };
            reader.readAsText(file);
          });
        }
      }

      function init() {
        loadStore();
        const today = getTodayString();
        state.selectedDate = today;
        ensureDay(today);
        initMainHandlers();
        initOtherHandlers();
        initFontSizeUI();
        render();
      }

      init();
    })();
  </script>
</body>
</html>

